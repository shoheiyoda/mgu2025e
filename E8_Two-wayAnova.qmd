---
title: "多元配置分散分析"
---

```{r setup}
#| include: false
library(tidyverse)
library(ggthemes)
library(car)
```
# データ・変数
## データ
[東大社研・若年パネル調査の非制限公開疑似データ](https://csrda.iss.u-tokyo.ac.jp/infrastructure/urd/jlps/)を用いる。

以下では次の問いに答えることを目的とする。

> Q: 学歴と性別によって個人収入に違いはあるのか？

なお、今回は分析対象を**25-34歳の男女**に限定する。

## 変数
「第7回 分散分析」の最後のセクションで保存した`Anova_SexEduIncome.rds`を用いる。以下の変数が格納された`tibble`になっているはずである。

- 回答者の性別: `sex`
- 回答者の学歴: `Edu`
  - 以下の3カテゴリにリコード済み
    - 中学・高校(`JHS/HS`)
    - 専門・短大(`VS/JC`)
    - 大学・大学院(`Univ`)
    
- 回答者の個人収入: `Income`
  - 回答選択肢の中央値にリコード済み

なお、回答者の年齢もすでに25-34歳に限定されている。

```{r}
library(tidyverse)
FN_Data2Load <- "data/Anova_SexEduIncome.rds"
DF_org <- read_rds(FN_Data2Load)
```

回答者の性別`sex`は原データの変数がそのまま入ったものなので、カテゴリカル変数として定義し直しておこう。

```{r}
DF <- 
  DF_org |> 
  mutate(Sex = if_else(sex == 1, "Men", "Women")) |> 
  select(Sex, Edu3Grp, Income)
```

# グループ別平均値の算出
つづいて、グループ別に個人収入の平均値を算出する。今回の例では、性別と学歴の2つの説明変数が存在するため、これら2変数の組み合わせからなるグループ別に平均値を算出してみよう。

## {base}
{base}環境でグループ別に統計量を算出するためには`tapply()`が便利である。これは`apply()`関数族の一種であり、`apply()`は行列や配列に適用するのに対して`tapply()`はベクトルに適用される。`tapply()`は主に3つの引数からなり、

- `X`: 関数を適用する対象となるベクトル
- `INDEX`: グループ化するためのカテゴリを指定する要素（ベクトルやリスト）
- `FUN`: 適用する関数

2変数以上の組み合わせからなるグループ別に統計量を算出する場合、2つめの引数`INDEX`をリストで引き渡すことがポイントである。

```{r}
DF |> with(tapply(Income, list(Sex, Edu3Grp), mean))  # tapplyで複数の要因ごとに処理を施すためにはlistで引き渡す
DF |> with(tapply(Income, list(Sex, Edu3Grp), sd)) 
DF |> with(tapply(Income, list(Sex, Edu3Grp), length)) # グループ別の客体数
```

このように、`tapply()`の返り値は行列（や配列）のため、グループ別の集計結果も視覚的にわかりやすい。

## {tidyverse}
「第7回 分散分析」でも確認したように、グループ別の集計は{tidyverse}でも簡単に行うことができる。グルーピングに用いる変数が2つ以上の場合は、`group_by()`にそれらの変数を指定する。

```{r}
DF |>  
  group_by(Sex, Edu3Grp) |>  
  reframe(Mean = mean(Income),
          SD   =   sd(Income),
          Obs  = n())
```

# データの可視化
多元配置分散分析では説明変数が増えていくにつれてグループ数も増えていく。そのため、算出されたグループ別平均を眺めているだけではどのような傾向が見られるのかわかりにくいことも少なくない。そこで、まずはグループ別平均を可視化しておくとよい。

```{r}
# グラフ化するデータの準備
data2plot <-
  DF |> 
  group_by(Sex, Edu3Grp) |>  
  reframe(Mean = mean(Income),
          SE = sd(Income) / sqrt(n())
          ) |> 
  mutate(
    CI_lower = Mean - qt(0.975, df = n()-1) * SE,  # 95%信頼区間下限
    CI_upper = Mean + qt(0.975, df = n()-1) * SE   # 95%信頼区間上限
  )
```

今回の例では、性別と学歴の組み合わせごとに個人収入の平均値が算出されている。このデータを可視化するにあたって、以下の2つの「データの眺め方」があることに注意されたい。

1. 学歴別にみた個人収入の男女差
2. 男女別にみた個人収入の学歴差

1において関心があるのは「個人収入に対する性別の効果」である。さらにいえば、そうした収入の男女間格差が学歴階層によって異なるのか、という問いにも対応している。後者はいわゆる交互作用効果（interaction effects）の有無を問うことになる。

一方で、2において関心があるのは「個人収入に対する学歴の効果」、そして収入の学歴差が男女間で異なるのか、という問いである。

これらの2つの視点の違いに注意しながら、それぞれデータを可視化すると以下のようになる。

::: {.panel-tabset}
## 学歴別にみた個人収入の男女差
```{r}
#| code-fold: true

data2plot |>  
  ggplot(aes(x = Sex,
             y = Mean)
         ) +
  facet_grid(~ Edu3Grp) +
  geom_point() +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.2) +
  ylim(0, 500) +
  theme_few() +
  theme(strip.text   = element_text(size = rel(1.5)),
        axis.text.x  = element_text(size = rel(1.5)),
        axis.text.y  = element_text(size = rel(1.5)),
        axis.title.x = element_text(size = rel(1.5)),
        axis.title.y = element_text(size = rel(1.3)))
```

## 男女別にみた個人収入の学歴差
```{r}
#| code-fold: true

data2plot |>  
  ggplot(aes(x = Edu3Grp,
             y = Mean)
         ) +
  facet_grid(~Sex) +
  geom_point() +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.2) +
  ylim(0, 500) +
  theme_few() +
  theme(strip.text   = element_text(size = rel(1.5)),
        axis.text.x  = element_text(size = rel(1.5)),
        axis.text.y  = element_text(size = rel(1.5)),
        axis.title.x = element_text(size = rel(1.5)),
        axis.title.y = element_text(size = rel(1.3)))
```
:::

# 多元配置分散分析
一元配置分散分析の際には`anova()`を用いた。多元配置分散分析にも同じ関数を用いることができるが、後に見るように多くの計量社会学的分析においては別の関数を使うことが一般的である。まずは`anova()`関数を用いて多元配置分散分析を行ってみよう。一元配置分散分析の時と同様に、`lm`の後に「従属変数 ~ 独立変数」の形式でモデル式を指定すればよい。独立変数が複数ある場合は`+`でつなぐ。

```{r}
DF |> with(anova(lm(Income ~ Sex + Edu3Grp)))
```

分散分析表に性別と学歴の2つの説明変数が表示されており、一見すると何の問題もないように見える。しかし、ここで`lm`の中で説明変数を投入する順番を入れ替えてみよう。

```{r}
DF |> with(anova(lm(Income ~ Edu3Grp + Sex)))
```

先ほどの分散分析表と比較すると、性別と学歴それぞれの平方和（および平均平方）が異なることがわかる。これは`anova()`では「タイプⅠ平方和」という種類の平方和の算出方法が用いられているためである。これは平方和の分解を逐次的に行うものである。すなわち、

1. まず最初に投入した変数Aによって説明される平方和を算出する。
2. つぎに、投入される変数Bによって「変数Aでは説明されなかった残差平方話」の中で説明される平方和を抽出する。
3. 以下、変数Cについても同様

という手順で平方和の分解がなされる。計量社会学的な分析ではタイプⅠ平方和が使われることはあまりない。むしろ、同じ水準の中では優先順位をつけないタイプⅡ平方和がより一般的である。平方和の種類にはタイプⅠからタイプⅣまであり、詳細は南風原（2002）などを参照されたい。タイプⅡ平方和による分散分析を行うためには`car`パッケージ内の`anova()`を用いる。

```{r}
library(car)
DF |> with(Anova(lm(Income ~ Sex + Edu3Grp)))
DF |> with(Anova(lm(Income ~ Edu3Grp + Sex)))
```

モデル式の中で説明変数の順番を入れ替えても分散分析の結果が変わらないことがわかる。上記の結果からは、性別・学歴によって個人収入に違いがある（正確には、「性別・学歴によらず個人収入が同じとは言えない」）ことがわかる。

# 交互作用項
最後に、性別と学歴の交互作用効果を検討してみよう。この交互作用効果を有無を分析にすることによって、

- 個人収入の男女差は学歴階層によって異なるのか？
- 個人収入の学歴差は性別によって異なるのか？

といった問いに答えることができる。交互作用項をモデル式の中で表現する方法は2つある。変数Aの主効果、変数Bの主効果、両変数からなる交互作用効果をモデル式に組み込む場合、

- 方法1：`A + B + A:B`
- 方法2：`A*B`

の2つの表現方法がある。方法1は交互作用を表す項が`A:B`として表現されている。方法2の場合、`*`でつながれている変数の主効果と交互作用効果が全てモデル式に投入される。方法1を用いると例えば、

- `A + A:B`

のように、交互作用項を構成している変数のうち、一部の主効果を除いた式も書くことができる（上記の場合、変数Bの主効果がない）。しかしながら、このモデル式が使われることはほとんどなく、原則として**交互作用項を含む場合はそれを構成する変数の主効果を必ず含める**と覚えておけばよい。そのため、上記の方法1と方法2のどちらを用いてもよい。

::: {.panel-tabset}
## 方法1
```{r}
DF |> with(Anova(lm(Income ~ Sex + Edu3Grp + Sex:Edu3Grp)))
```

## 方法2
```{r}
DF |> with(Anova(lm(Income ~ Sex*Edu3Grp)))
```
:::

`Sex:Edu3Grp`のp値を見ると、有意水準5%を上回っており、性別と学歴の交互作用効果は統計的に有意ではない。

そのため、結論としては

- 個人収入の男女差は学歴階層によって異なるとは言えない
- 個人収入の学歴差は性別によって異なるとは言えない

となる。

# 補足：P-hacking
なお、統計的検定に用いる有意水準は事前に定めるべきものであり、分析結果を見てから有意水準を変更することは避けるべきである。今回の例で言えば、`Sex:Edu3Grp`のp値は.05を僅かに上回るだけであり、変数の操作化や分析対象の限定を少し修正するだけで.05を下回るp値を得られるかもしれない。しかしながら、このように統計的に有意な結果を得るためにデータや分析方法を操作することは「pハッキング（P-hacking）」と呼ばれ、研究の再現性を歪めるものとして避けるべきと考えられている。pハッキングは「疑わしい研究（不正）行為（Questionable Research Practices）」のひとつとしてよく挙げられる。

また、p値が10%は下回っているが5%は上回っている場合に時折、

> 10%水準で有意傾向が見られた

などと表現している論文を見かけることがあるが、「有意傾向」という用語は適切ではないし、pハッキングではないにしてもその一歩手前のような都合の良い結果の解釈とも受け止められかねない。

こうした事態を避けるためには、事前に設定した有意水準を遵守するか、そもそもp値に基づく離散的な（"all or nothing"）判断を取らない、という方針が考えられる。後者は一部の国際ジャーナルでも浸透しつつあるガイドラインであり、例えば[Bijak (2019)](https://www.demographic-research.org/articles/volume/41/32)を参照されたい。




